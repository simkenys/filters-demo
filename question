import React, { useEffect, useState } from 'react';
import { Card, CardActionArea, CardContent, Typography } from '@mui/material';
import useFetchBlobData from '../../dataHooks/useFetchBlobData';
import { useGlobalStore } from '../../contexts/useGlobalStore';
import useFetchUser from '../../dataHooks/useFetchUser';
import { closeSnackbar, useSnackbar } from 'notistack';

const CardDownload = () => {
  const { enqueueSnackbar } = useSnackbar();
  const [snackbarId, setSnackbarId] = useState(null);

  const { refogId } = useGlobalStore();
  const { user } = useFetchUser({ refogId });

  const [fetchRequested, setFetchRequested] = useState(false);

  const { data, error, isLoading } = useFetchBlobData(
    fetchRequested ? user?.currentUser : null
  );

  useEffect(() => {
    if (!isLoading && snackbarId !== null && fetchRequested) {
      // ----- Guard: make sure we actually have a blob -----
      const record = data?.[0];
      if (!record?.blob) {
        enqueueSnackbar('No XLSX data received.', { variant: 'error' });
        closeSnackbar(snackbarId);
        setSnackbarId(null);
        setFetchRequested(false);
        return;
      }

      // ----- Convert to Blob if needed -----
      const xlsxBlob =
        record.blob instanceof Blob
          ? record.blob
          : typeof record.blob === 'string'
          ? // helper to turn base64 string into Blob
            (() => {
              const byteChars = atob(record.blob);
              const byteNumbers = new Array(byteChars.length);
              for (let i = 0; i < byteChars.length; i++) {
                byteNumbers[i] = byteChars.charCodeAt(i);
              }
              const byteArray = new Uint8Array(byteNumbers);
              return new Blob([byteArray], {
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
              });
            })()
          : new Blob([record.blob]);

      // ----- Create download link -----
      const url = URL.createObjectURL(xlsxBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'extract.xlsx'; // you can customize the name
      document.body.appendChild(a);
      a.click();

      // Cleanâ€‘up (delay revocation to avoid race)
      setTimeout(() => {
        URL.revokeObjectURL(url);
        a.remove();
      }, 0);

      // ----- UI feedback -----
      closeSnackbar(snackbarId);
      setSnackbarId('null');
      enqueueSnackbar('XLSX data fetch finished!', {
        variant: 'success',
      });
      setFetchRequested(false);
    }
  }, [isLoading, snackbarId, fetchRequested, enqueueSnackbar, data]);

  const handleCardClick = () => {
    if (fetchRequested) return;

    const id = enqueueSnackbar(
      "XLSX data fetch started - please don't navigate away!",
      {
        variant: 'info',
        persist: true,
      }
    );
    setSnackbarId(id);
    setFetchRequested(true);
  };

  useEffect(() => {
    return () => {
      if (snackbarId !== null) {
        closeSnackbar(snackbarId);

        // // TODO:  Need to let this error only show when the user navigates away, now it also shows on success
        if (fetchRequested) {
          enqueueSnackbar('XLSX data fetch failed by navigating away!', {
            variant: 'error',
            persist: false,
          });
        }
      }
    };
  }, [snackbarId, fetchRequested, enqueueSnackbar]);

  // const handleCardClick = async () => {
  // // From UNC Path
  // const fileName = 'RAR_Download_d57718_2025-11-30.xlsx';
  // const response = await fetch(
  //   'api/Download?fileName=${encodeURIComponent(fileName)}',
  //   {
  //     method: 'GET',
  //     credentials: 'include',
  //   }
  // );
  // if (!response.ok) {
  //   throw new Error('Download failed');
  // }
  // const blob = await response.blob();
  // const url = window.URL.createObjectURL(blob);
  // const a = document.createElement('a');
  // a.href = url;
  // a.download = fileName;
  // document.body.appendChild(a);
  // a.click();
  // a.remove();
  // };

  return (
    <Card
      sx={{
        borderRadius: '12px',
        padding: 1.5,
        boxShadow: '0px 14px 40px rgba(34, 35, 58, 0.2)',
        cursor: 'pointer',
      }}>
      <CardActionArea
        sx={{ height: '300px' }}
        onClick={() => handleCardClick()}>
        <CardContent>
          <Typography gutterBottom variant="h5" component="div">
            Download extract (.xlsx)
          </Typography>
          <Typography variant="body2" sx={{ color: 'text.secondary' }}>
            Click here to download an extract in .xlsx format which contains all
            data you are allowed to see.
          </Typography>
        </CardContent>
      </CardActionArea>
    </Card>
  );
};

export default CardDownload;

import React, { forwardRef, lazy, Suspense, useMemo } from "react";
import {
  Drawer,
  Button,
  Box,
  Select,
  MenuItem,
  Checkbox,
  FormControlLabel,
  FormControl,
  InputLabel,
  ListItemIcon,
  ListItemText,
  Autocomplete,
  TextField,
  Divider,
  Stack,
  IconButton,
  Tooltip,
} from "@mui/material";
import useWindowDimensions from "../../hooks/useWindowDimensions";
// import {
//   CloseOutlined,
//   FilterAlt,
//   FilterAltOff,
// } from "@mui/icons-material";
const CloseOutlined = lazy(() => import("@mui/icons-material/CloseOutlined"));
const FilterAlt = lazy(() => import("@mui/icons-material/FilterAlt"));
const FilterAltOff = lazy(() => import("@mui/icons-material/FilterAltOff"));
import ExpandButton from "./ExpandButton";
import { useBreakpoints } from "../..";

const FilterPanel = forwardRef(
  (
    {
      filters,
      expanded,
      setExpanded,
      open,
      setOpen,
      isFooterVisible,
      resetFilters,
      hasActiveFilters,
      mode,
    },
    ref
  ) => {
    if (!filters || filters.length === 0) {
      console.warn("No filters passed as prop");
    }

    const { isLg, isXl } = useBreakpoints();

    const { height, width } = useWindowDimensions();

    const columnWidth = 350;
    const columnGap = 4;

    const maxItemsPerColumn = useMemo(() => {
      // 56 is the height 1 filterblock takes (including top and bottom padding, which the first and last only have 1 of the 2 off, so we need to add 16px)
      // 16 is the padding of 8 of the first and the padding of 8 of the last item per column that we substracted too much
      // 74 is the height loss from the top
      // 45 is the height loss of the footer
      const footerHeight = 0; //isFooterVisible ? 45 : 0;
      return Math.floor((height - 74 - footerHeight + 16) / 56);
    }, [height, width, isFooterVisible]);

    const columns = useMemo(() => {
      const cols = [];
      let i = 0;

      // Remove filters that only have 'All' from the filterPanel, whilst still keeping the placeholders and titles etc
      const filtersToShow = filters?.filter(
        (d) =>
          !d.options ||
          d.options.length > 1 ||
          d.canHide === undefined ||
          !d.canHide
      );

      if (isLg || isXl) {
        while (i < filtersToShow.length) {
          let myCols = filtersToShow.slice(i, i + maxItemsPerColumn);

          let blancCount = 0;

          // Check if the last item's type is 'title'
          if (myCols.length > 0 && myCols[myCols.length - 1].type === "title") {
            myCols = filtersToShow.slice(i, i + maxItemsPerColumn - 1);
            myCols.push({ type: "blanc" });
            blancCount++;
          }

          // Check if the first item's type is not 'title'
          if (myCols.length > 0 && myCols[0].type !== "title") {
            myCols = filtersToShow.slice(i, i + maxItemsPerColumn - 1);
            myCols.unshift({ type: "blanc" });
            blancCount++;
          }

          cols.push(myCols);

          // Adjust the index to account for the additional items
          i += maxItemsPerColumn - blancCount;
        }
      } else {
        cols.push(filtersToShow);
      }

      return cols;
    }, [filters, maxItemsPerColumn, width, height, isFooterVisible]);

    const handleOnClickFiltersButton = () => {
      setOpen(true);
    };

    const handleOnClickShowFiltersButton = () => {
      setExpanded(!expanded);
    };

    const handleClickResetFilters = () => {
      resetFilters();
    };

    return (
      <Box>
        <Stack
          spacing={1}
          direction="row"
          justifyContent={"flex-end"}
          alignItems={"center"}
        >
          <Tooltip
            title={
              "Show the status of all filters, usefull for screenshots etc."
            }
          >
            <ExpandButton
              expanded={expanded}
              onClick={() => handleOnClickShowFiltersButton()}
            />
          </Tooltip>

          <Tooltip title={"Reset filters"}>
            <IconButton
              disabled={!hasActiveFilters}
              onClick={() => handleClickResetFilters()}
            >
              <Suspense fallback={null}>
                <FilterAltOff
                  sx={{
                    fill: (theme) =>
                      hasActiveFilters
                        ? theme.palette.bnp.main
                        : mode === "light"
                        ? "#ccc"
                        : "#555",
                  }}
                />
              </Suspense>
            </IconButton>
          </Tooltip>

          <Button
            variant="contained"
            size="small"
            onClick={() => handleOnClickFiltersButton()}
          >
            {/* <FilterList /> Filters */}
            <Suspense fallback={null}>
              <FilterAlt />
            </Suspense>{" "}
            Filters
          </Button>
        </Stack>

        <Drawer
          ref={ref}
          anchor="right"
          open={open}
          onClose={() => setOpen(false)}
          sx={{
            "& .MuiDrawer-paper": {
              top: "42px",
              height:
                isLg || isXl ? "calc(100vh - 42px)" : "calc(100vh - 98px)",
              display: "flex",
              flexDirection: "row",
              background: (theme) => theme.palette.background.paper,
              p: isXl || isLg ? 2 : 0,
              overflow: !isLg && !isXl ? "hidden" : "inherit",
            },

            "& .MuiBackdrop-root": {
              top: "42px",
            },

            zIndex: 1202,
          }}
        >
          <Box
            sx={{
              display: "flex",
              height: "100%",
              overflowY: "auto",
              overflowX: isLg || isXl ? "inherit" : "auto",
              flexGrow: isLg || isXl ? 1 : 0,
              flexDirection: isLg || isXl ? "row" : "column",
              alignItems: "flex-start",
              gap: columnGap,
              p: !isLg && !isXl ? 2 : 0,

              // display: "flex",
              // flexDirection: "row",
              // gap: columnGap,
              // // height: isLg || isXl ? "calc(100% - 45px)" : "auto",
              // overflow: !isLg && !isXl ? "auto" : "inherit",
              // flexGrow: !isLg && !isXl ? 1 : "inherit",
              // p: !isLg && !isXl ? 2 : 0,
            }}
          >
            {columns.map((col, colIndex) => (
              <React.Fragment key={`col-${colIndex}`}>
                <Box
                  key={`col-${colIndex}`}
                  sx={{
                    width: columnWidth,
                    display: "flex",
                    flexDirection: "column",
                    gap: "16px",
                  }}
                >
                  {col.map((filter, idx) => (
                    <Box key={filter.id ?? idx}>
                      {filter.type === "blanc" && (
                        <FormControl
                          sx={{
                            width: "100%",
                            height: "40px",
                            minHeight: "40px",
                            maxHeight: "40px",
                          }}
                          size="small"
                        >
                          <Box sx={{ m: 0 }}>{""}</Box>
                        </FormControl>
                      )}
                      {filter.type === "title" && (
                        <FormControl
                          sx={{
                            width: "100%",
                            height: "40px",
                            minHeight: "40px",
                            maxHeight: "40px",
                            display: "flex",
                            flexDirection: "column",
                          }}
                          size="small"
                        >
                          <Box sx={{ m: 0, marginTop: "auto" }}>
                            {filter?.label}
                          </Box>
                        </FormControl>
                      )}
                      {filter.type === "autocomplete" && (
                        <FormControl
                          sx={{
                            width: "100%",
                            height: "40px",
                            minHeight: "40px",
                            maxHeight: "40px",
                          }}
                          size="small"
                        >
                          <Autocomplete
                            value={filter?.state}
                            onChange={(event, newValue) =>
                              filter?.handleChange(newValue)
                            }
                            options={filter?.options}
                            getOptionLabel={(option) => {
                              const index = filter?.options?.findIndex(
                                (opt) => opt === option
                              );
                              return index !== -1
                                ? filter?.optionsLabels[index]
                                : "Error";
                            }}
                            renderInput={(params) => (
                              <TextField
                                {...params}
                                variant="outlined"
                                size="small"
                                label={filter?.label}
                                placeholder="Search an option"
                                slotProps={{ inputLabel: { shrink: true } }}
                              />
                            )}
                            sx={{ paddingTop: "2px" }}
                          />
                        </FormControl>
                      )}

                      {filter.type === "select" && (
                        <FormControl
                          sx={{
                            width: "100%",
                            height: "40px",
                            minHeight: "40px",
                            maxHeight: "40px",
                          }}
                          size="small"
                        >
                          <InputLabel>{filter?.label}</InputLabel>
                          <Select
                            value={filter?.state}
                            label={filter?.label}
                            onChange={(event) => filter?.handleChange(event)}
                            displayEmpty
                          >
                            {filter?.options.map((opt, i) => (
                              <MenuItem
                                key={i}
                                value={opt}
                                sx={{ ...filter?.optionsSx?.[i] }}
                              >
                                {filter?.optionsLabels?.[i]}
                              </MenuItem>
                            ))}
                          </Select>
                        </FormControl>
                      )}
                      {filter.type === "checkbox" && (
                        <FormControlLabel
                          control={<Checkbox />}
                          label={filter.label}
                        />
                      )}
                      {filter.type === "multiselect" && (
                        <FormControl
                          sx={{
                            width: "100%",
                            height: "40px",
                            minHeight: "40px",
                            maxHeight: "40px",
                          }}
                          size="small"
                        >
                          <InputLabel shrink>{filter?.label}</InputLabel>
                          <Select
                            multiple
                            value={filter?.state}
                            label={filter?.label}
                            onChange={(event) => filter?.handleChange(event)}
                            renderValue={(selected) =>
                              selected?.length > 1
                                ? `${selected.length} selected`
                                : selected
                                    ?.map(
                                      (value) =>
                                        filter?.optionsLabels[
                                          filter?.options.indexOf(value)
                                        ]
                                    )
                                    ?.join(", ")
                            }
                            displayEmpty
                          >
                            {filter?.options?.map((opt, i) => (
                              <MenuItem
                                key={i}
                                value={opt}
                                sx={{
                                  padding: 0,
                                  pr: 2,
                                  ...filter?.optionsSx?.[i],
                                }}
                              >
                                <ListItemIcon>
                                  <Checkbox
                                    checked={filter?.state?.includes(opt)}
                                  />
                                </ListItemIcon>
                                <ListItemText>
                                  {filter?.optionsLabels?.[i]}
                                </ListItemText>
                              </MenuItem>
                            ))}
                          </Select>
                        </FormControl>
                      )}
                    </Box>
                  ))}
                </Box>
                {columns?.length > 1 && colIndex < columns.length - 1 && (
                  <Divider
                    orientation="vertical"
                    flexItem
                    sx={{ mt: "12px" }}
                  />
                )}
              </React.Fragment>
            ))}
          </Box>

          <IconButton
            onClick={() => handleClickResetFilters()}
            disabled={!hasActiveFilters}
            sx={{
              position: "absolute",
              top: 8,
              right: 48,
            }}
          >
            <Suspense fallback={null}>
              <FilterAltOff
                sx={{
                  fill: (theme) =>
                    hasActiveFilters
                      ? theme.palette.bnp.main
                      : mode === "light"
                      ? "#ccc"
                      : "#555",
                }}
              />
            </Suspense>
          </IconButton>

          <IconButton
            onClick={() => setOpen(false)}
            sx={{
              position: "absolute",
              top: 8,
              right: 8,
            }}
          >
            <Suspense fallback={null}>
              <CloseOutlined />
            </Suspense>
          </IconButton>
        </Drawer>
      </Box>
    );
  }
);

export default FilterPanel;

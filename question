// useGenerateFilter.js
import { useState, useEffect, useRef } from 'react';
import { useGlobalStore } from '../../contexts/useGlobalStore';
import { useSearchParams } from 'react-router-dom';

export const useGenerateFilter = ({
  deps = [],
  depFields = [],
  defaultValue = '-1',
  isMulti = false,
  filterFunction,
  filterField,
  hideWhenNoParentValue = false,
  compareType = 'int',
}) => {
  const { setLastChangedEntityFilter } = useGlobalStore();
  const [searchParams] = useSearchParams();

  // --- 1. Capture URL override ONCE and store it ---
  const urlOverrideRef = useRef(null);
  const hasCheckedUrl = useRef(false);

  if (!hasCheckedUrl.current) {
    const paramValue = searchParams.get(filterField);
    if (paramValue !== null) {
      if (isMulti) {
        urlOverrideRef.current = paramValue.split(',').filter(Boolean);
      } else {
        if (paramValue === 'true') urlOverrideRef.current = true;
        else if (paramValue === 'false') urlOverrideRef.current = false;
        else urlOverrideRef.current = paramValue;
      }
    }
    hasCheckedUrl.current = true;
  }

  // --- 2. Initialize state with URL value OR default ---
  const initialValue = urlOverrideRef.current !== null 
    ? urlOverrideRef.current 
    : (isMulti ? [defaultValue] : defaultValue);

  const [filterValue, setFilterValue] = useState(initialValue);
  const [filterDep, setFilterDep] = useState(deps);
  const [filterFieldState] = useState(filterField);

  const prevDeps = useRef(deps);

  // --- 3. Watch dependency changes ---
  useEffect(() => {
    if (JSON.stringify(deps) !== JSON.stringify(prevDeps.current)) {
      setFilterDep(deps);
      prevDeps.current = deps;
    }
  }, [deps]);

  // --- 4. Load options ---
  const {
    data: filterData,
    isLoading: filterLoading,
    isError: filterError,
  } = filterFunction(filterDep, depFields, filterFieldState);

  // --- 5. Handlers ---
  const handleChange = (event) => {
    const value = event.target?.value ?? event;

    if (
      ['level4Cd', 'level5Cd', 'level6Cd', 'level7Cd', 'level8Cd'].includes(
        filterFieldState
      )
    ) {
      setLastChangedEntityFilter(filterFieldState);
    }

    if (isMulti) {
      if (Array.isArray(value) && value[value.length - 1] === '-1')
        setFilterValue(['-1']);
      else if (Array.isArray(value))
        setFilterValue(value.filter((v) => v !== '-1'));
      else setFilterValue([value]);
    } else {
      setFilterValue(value);
    }

    // Clear URL override after first user interaction
    urlOverrideRef.current = null;
  };

  const handleManualUpdate = (value) => {
    if (['level8Cd'].includes(filterFieldState))
      setLastChangedEntityFilter(filterFieldState);

    setFilterValue(isMulti ? [value] : value);
    urlOverrideRef.current = null;
  };

  return {
    filterValue,
    setFilterValue,
    filterField: filterFieldState,
    filterData,
    filterLoading,
    filterError,
    handleChange,
    handleManualUpdate,
    setFilterDep,
    defaultValue,
    isMulti,
    hideWhenNoParentValue,
    compareType,
    urlOverride: urlOverrideRef.current, // EXPOSE this
  };
};

// useFilterUpdater.js (UPDATED)
import { useEffect } from "react";

const useFilterUpdater = (
  data,
  id,
  setFilters,
  state,
  setState,
  defaultValue = null,
  urlOverride = null // NEW PARAMETER
) => {
  useEffect(() => {
    if (!data) return;

    let updatedState;
    const updatedFilters = (prevFilters) =>
      prevFilters.map((filter) => {
        if (filter.id === id) {
          const newOptions = data.options || [];
          const newOptionsLabels = data.optionsLabels || [];
          const newOptionsSx = data.optionsSx || [];

          if (Array.isArray(state)) {
            // multi select
            
            // PRIORITY 1: Try to preserve URL override if it's valid
            if (urlOverride && Array.isArray(urlOverride)) {
              const validUrlValues = urlOverride.filter((d) => newOptions.includes(d));
              if (validUrlValues.length > 0) {
                updatedState = validUrlValues;
              } else {
                // URL values not in options yet, keep them temporarily
                updatedState = urlOverride;
              }
            } else {
              // PRIORITY 2: Try to preserve current state
              const matchingStates = state.filter((d) => newOptions.includes(d));

              if (matchingStates.length === 0) {
                updatedState = defaultValue
                  ? [defaultValue]
                  : newOptions[0] ?? [""];
              } else {
                updatedState = matchingStates;
              }
            }
          } else {
            // single select
            
            // PRIORITY 1: Try to preserve URL override if it's valid
            if (urlOverride !== null) {
              const isUrlValid = newOptions.includes(urlOverride);
              if (isUrlValid) {
                updatedState = urlOverride;
              } else {
                // URL value not in options yet, keep it temporarily
                updatedState = urlOverride;
              }
            } else {
              // PRIORITY 2: Try to preserve current state
              const isStateValid = newOptions.includes(state);

              if (!isStateValid) {
                updatedState = defaultValue ?? newOptions[0] ?? "";
              } else {
                updatedState = state;
              }
            }
          }

          return {
            ...filter,
            state: updatedState,
            options: newOptions,
            optionsLabels: newOptionsLabels,
            optionsSx: newOptionsSx,
          };
        }
        return filter;
      });

    setFilters((prevFilters) => {
      const newFilters = updatedFilters(prevFilters);
      if (JSON.stringify(state) !== JSON.stringify(updatedState)) {
        setState(updatedState);
      }

      return newFilters;
    });
  }, [data, id, setFilters, state, setState, defaultValue, urlOverride]);
};

export default useFilterUpdater;

// useFilterStore.jsx (UPDATED - only the useFilterUpdater calls)
// ... all your imports stay the same ...

export const FilterStoreProvider = ({ children }) => {
  // ... all your existing code stays exactly the same until the Filter updater section ...

  // ---------------- Filter updater ----------------
  Object.entries(hooksMap).forEach(([id, hook]) => {
    useFilterUpdater(
      hook.filterData,
      id,
      setFilters,
      hook.filterValue,
      hook.setFilterValue,
      hook.defaultValue,
      hook.urlOverride // PASS THE URL OVERRIDE
    );
  });

  // ... rest of your code stays exactly the same ...
};
import React, { createContext, useContext, useEffect, useState } from 'react';
import { usePeriodFilter } from '../hooks/filters/viewFilters/usePeriodFilter';
import { useToDoCategoryFilter } from '../hooks/filters/viewFilters/useToDoCategoryFilter';
import { useCampaignFilter } from '../hooks/filters/viewFilters/useCampaignFilter';
import { useScopeFilter } from '../hooks/filters/entityFilters/useScopeFilter';
import { useCoverageFilter } from '../hooks/filters/entityFilters/useCoverageFilter';
import { useRegionFilter } from '../hooks/filters/entityFilters/useRegionFilter';
import { useBCFilter } from '../hooks/filters/entityFilters/useBCFilter';
import { useSubBCFilter } from '../hooks/filters/entityFilters/useSubBCFilter';
import { useRMFilter } from '../hooks/filters/entityFilters/useRMFilter';
import { useSegmentFilter } from '../hooks/filters/clientFilters/useSegmentFilter';
import { usePriorityFilter } from '../hooks/filters/clientFilters/usePriorityFilter';
import { useMainCategoryFilter } from '../hooks/filters/clientFilters/useMainCategoryFilter';
import { useCategoryFilter } from '../hooks/filters/clientFilters/useCategoryFilter';
import { useSubCategoryFilter } from '../hooks/filters/clientFilters/useSubCategoryFilter';
import { useTodoTypeFilter } from '../hooks/filters/viewFilters/useToDoTypeFilter';
import { useToDoSubTypeFilter } from '../hooks/filters/viewFilters/useToDoSubTypeFilter';
import { useGlobalStore } from './useGlobalStore';
import useFetchUser from '../dataHooks/useFetchUser';
import { useGenerateFilter } from '../filterConfig/hooks/useGenerateFilter';
import useFilterUpdater from '../filterConfig/hooks/useFilterUpdater';
import { filterConfigsMap } from '../filterConfig/filterConfig';

//@ts-ignore
const FilterStoreContext = createContext();

export const FilterStoreProvider = ({ children }) => {
  const { refogId } = useGlobalStore();
  const { user } = useFetchUser({ refogId });
  const [userFunction, setUserFunction] = useState('default');

  // ---------------- Static hooks for all filters ----------------
  const period = useGenerateFilter({
    filterFunction: usePeriodFilter,
    filterField: 'year',
    defaultValue: '2025',
  });
  const todocat = useGenerateFilter({
    deps: [period.filterValue],
    depFields: ['year'],
    filterFunction: useToDoCategoryFilter,
    filterField: 'todoCategoryKey',
    isMulti: true,
  });
  const todotype = useGenerateFilter({
    deps: [period.filterValue, todocat.filterValue],
    depFields: ['year', 'todoCategoryKey'],
    filterFunction: useTodoTypeFilter,
    filterField: 'todoTypeKey',
    isMulti: true,
  });
  const todosubtype = useGenerateFilter({
    deps: [period.filterValue, todocat.filterValue, todotype.filterValue],
    depFields: ['year', 'todoCategoryKey', 'todoTypeKey'],
    filterFunction: useToDoSubTypeFilter,
    filterField: 'todoSubTypeKey',
    isMulti: true,
  });
  const campaign = useGenerateFilter({
    deps: [
      period.filterValue,
      todocat.filterValue,
      todotype.filterValue,
      todosubtype.filterValue,
    ],
    depFields: ['year', 'todoCategoryKey', 'todoTypeKey', 'todoSubTypeKey'],
    filterFunction: useCampaignFilter,
    filterField: 'fkCampaign',
    isMulti: true,
  });

  const scope = useGenerateFilter({
    deps: [period.filterValue],
    depFields: ['year'],
    filterFunction: useScopeFilter,
    filterField: 'scopeKey',
  });
  const coverage = useGenerateFilter({
    deps: [period.filterValue, scope.filterValue],
    depFields: ['year', 'scopeKey'],
    filterFunction: useCoverageFilter,
    filterField: 'level4Cd',
  });
  const region = useGenerateFilter({
    deps: [period.filterValue, scope.filterValue, coverage.filterValue],
    depFields: ['year', 'scopeKey', 'level4Cd'],
    filterFunction: useRegionFilter,
    filterField: 'level5Cd',
  });
  const bc = useGenerateFilter({
    deps: [
      period.filterValue,
      scope.filterValue,
      coverage.filterValue,
      region.filterValue,
    ],
    depFields: ['year', 'scopeKey', 'level4Cd', 'level5Cd'],
    filterFunction: useBCFilter,
    filterField: 'level6Cd',
  });
  const subbc = useGenerateFilter({
    deps: [
      period.filterValue,
      scope.filterValue,
      coverage.filterValue,
      region.filterValue,
      bc.filterValue,
    ],
    depFields: ['year', 'scopeKey', 'level4Cd', 'level5Cd', 'level6Cd'],
    filterFunction: useSubBCFilter,
    filterField: 'level7Cd',
  });
  const rm = useGenerateFilter({
    deps: [
      period.filterValue,
      scope.filterValue,
      coverage.filterValue,
      region.filterValue,
      bc.filterValue,
      subbc.filterValue,
    ],
    depFields: [
      'year',
      'scopeKey',
      'level4Cd',
      'level5Cd',
      'level6Cd',
      'level7Cd',
    ],
    filterFunction: useRMFilter,
    filterField: 'level8Cd',
  });

  const segment = useGenerateFilter({
    deps: [period.filterValue],
    depFields: ['year'],
    filterFunction: useSegmentFilter,
    filterField: 'segmentKey',
    isMulti: true,
  });
  const priority = useGenerateFilter({
    deps: [period.filterValue],
    depFields: ['year'],
    filterFunction: usePriorityFilter,
    filterField: 'priorityKey',
    isMulti: true,
  });
  const maincategory = useGenerateFilter({
    deps: [period.filterValue],
    depFields: ['year'],
    filterFunction: useMainCategoryFilter,
    filterField: 'mainCategoryKey',
  });
  const category = useGenerateFilter({
    deps: [period.filterValue, maincategory.filterValue],
    depFields: ['year', 'mainCategoryKey'],
    filterFunction: useCategoryFilter,
    filterField: 'categoryKey',
  });
  const subcategory = useGenerateFilter({
    deps: [period.filterValue, maincategory.filterValue, category.filterValue],
    depFields: ['year', 'mainCategoryKey', 'categoryKey'],
    filterFunction: useSubCategoryFilter,
    filterField: 'subCategoryKey',
    isMulti: true,
  });

  const hooksMap = {
    period,
    todocat,
    todotype,
    todosubtype,
    campaign,
    scope,
    coverage,
    region,
    bc,
    subbc,
    rm,
    segment,
    priority,
    maincategory,
    category,
    subcategory,
  };

  // ---------------- Dynamic config based on user.function ----------------
  const [activeConfig, setActiveConfig] = useState(filterConfigsMap.default);
  useEffect(() => {
    const userFunc = user?.isImpersonating ? 'Admin' : 'default';
    setUserFunction(userFunc);

    if (userFunc === 'Admin' && filterConfigsMap.admin) {
      console.log('admin');
      setActiveConfig(filterConfigsMap.admin);
    } else {
      console.log('default');
      setActiveConfig(filterConfigsMap.default);
    }
  }, [user, setUserFunction, setActiveConfig]);

  // ---------------- Build filters array with real options & defaultValue state ----------------
  const [filters, setFilters] = useState([]);
  useEffect(() => {
    const builtFilters = activeConfig.flatMap((section) => {
      const title = {
        id: section.section,
        type: 'title',
        label: section.section,
      };
      const sectionFilters = section.filters.map((f) => {
        const hook = hooksMap[f.name];
        const options = hook.filterData?.options || [];
        const optionsLabels = hook.filterData?.optionsLabels || [];
        const optionsSx = hook.filterData?.optionsSx || [];

        // **State: use hook.filterValue if defined, else defaultValue**

        // console.log(hook);
        const state =
          hook.filterValue !== undefined
            ? hook.filterValue
            : hook.isMulti
            ? [hook.defaultValue]
            : hook.defaultValue;

        return {
          id: f.id,
          type: hook.isMulti ? 'multiselect' : 'select',
          label: f.label,
          state,
          handleChange: hook.handleChange,
          handleManualUpdate: hook.handleManualUpdate,
          options,
          optionsLabels,
          optionsSx,
          parentDeps: f.parentDeps || [],
        };
      });
      return [title, ...sectionFilters];
    });

    setFilters(builtFilters);
  }, [
    activeConfig,
    ...Object.values(hooksMap).map((h) => h.filterValue),
    ...Object.values(hooksMap).map((h) => h.filterData),
  ]);

  // ---------------- Filter updater ----------------
  Object.entries(hooksMap).forEach(([name, hook]) => {
    useFilterUpdater(
      hook.filterData,
      name,
      setFilters,
      hook.filterValue,
      hook.setFilterValue,
      hook.defaultValue
    );
  });

  // ---------------- Reset filters ----------------
  const resetFilters = () => {
    Object.values(hooksMap).forEach((h) => h.setFilterValue(h.defaultValue));
  };

  // ---------------- Loading / Error ----------------
  const isLoading = Object.values(hooksMap).some((h) => h.filterLoading);
  const isError = Object.values(hooksMap).some((h) => h.filterError);

  return (
    <FilterStoreContext.Provider
      value={{ filters, setFilters, resetFilters, isLoading, isError }}>
      {children}
    </FilterStoreContext.Provider>
  );
};

export const useFilterStore = () => useContext(FilterStoreContext);

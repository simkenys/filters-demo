import { useState, useEffect, useRef } from 'react';
import { useGlobalStore } from '../../contexts/useGlobalStore';

export const useGenerateFilter = ({
  deps = [],
  depFields = [],
  defaultValue = '-1',
  isMulti = false,
  filterFunction,
  filterField,
  hideWhenNoParentValue = false,
  compareType = 'int',
}) => {
  const { setLastChangedEntityFilter } = useGlobalStore();

  const [filterValue, setFilterValue] = useState(
    isMulti ? [defaultValue] : defaultValue
  );
  const [filterDep, setFilterDep] = useState(deps);
  const [filterFieldState] = useState(filterField);

  const prevDeps = useRef(deps);

  useEffect(() => {
    if (JSON.stringify(deps) !== JSON.stringify(prevDeps.current)) {
      setFilterDep(deps);
      prevDeps.current = deps;
    }
  }, [deps]);

  const {
    data: filterData,
    isLoading: filterLoading,
    isError: filterError,
  } = filterFunction(filterDep, depFields, filterFieldState);

  const handleChange = (event) => {
    const value = event.target?.value ?? event;

    if (
      ['level4Cd', 'level5Cd', 'level6Cd', 'level7Cd', 'level8Cd'].includes(
        filterFieldState
      )
    ) {
      setLastChangedEntityFilter(filterFieldState);
    }

    if (isMulti) {
      if (Array.isArray(value) && value[value.length - 1] === '-1')
        setFilterValue(['-1']);
      else if (Array.isArray(value))
        setFilterValue(value.filter((v) => v !== '-1'));
      else setFilterValue([value]);
    } else setFilterValue(value);
  };

  const handleManualUpdate = (value) => {
    if (['level8Cd'].includes(filterFieldState))
      setLastChangedEntityFilter(filterFieldState);
    setFilterValue(isMulti ? [value] : value);
  };

  return {
    filterValue,
    setFilterValue,
    filterField: filterFieldState,
    filterData,
    filterLoading,
    filterError,
    handleChange,
    handleManualUpdate,
    setFilterDep,
    defaultValue,
    isMulti,
    hideWhenNoParentValue,
    compareType,
  };
};

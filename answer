import { useEffect, useRef, useState } from 'react';
import { closeSnackbar, useSnackbar } from 'notistack';

export const useDownloadWithSnackbar = ({
  data,
  isLoading,
  fetchRequested,
  setFetchRequested,
}) => {
  const { enqueueSnackbar } = useSnackbar();
  const [snackbarId, setSnackbarId] = useState(null);

  // âœ… unchanged lifecycle flag
  const completedRef = useRef(false);

  const start = () => {
    if (fetchRequested) return;

    completedRef.current = false;

    const id = enqueueSnackbar(
      "XLSX data fetch started - please don't navigate away!",
      {
        variant: 'info',
        persist: true,
      }
    );

    setSnackbarId(id);
    setFetchRequested(true); // ðŸ”‘ triggers fetch (UNCHANGED BEHAVIOR)
  };

  useEffect(() => {
    if (!fetchRequested || isLoading || snackbarId === null) return;

    const record = data?.[0];
    if (!record?.blob) {
      enqueueSnackbar('No XLSX data received.', { variant: 'error' });
      closeSnackbar(snackbarId);
      setSnackbarId(null);
      setFetchRequested(false);
      return;
    }

    // ðŸ”’ EXACT CODE FROM YOUR ORIGINAL COMPONENT â€” NOT TOUCHED
    const xlsxBlob =
      record.blob instanceof Blob
        ? record.blob
        : typeof record.blob === 'string'
        ? (() => {
            const byteChars = atob(record.blob);
            const byteNumbers = new Array(byteChars.length);
            for (let i = 0; i < byteChars.length; i++) {
              byteNumbers[i] = byteChars.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], {
              type:
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
            });
          })()
        : new Blob([record.blob]);

    // ðŸ”’ EXACT DOWNLOAD LOGIC â€” NOT TOUCHED
    const url = URL.createObjectURL(xlsxBlob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'extract.xlsx';
    document.body.appendChild(a);
    a.click();

    setTimeout(() => {
      URL.revokeObjectURL(url);
      a.remove();
    }, 0);

    completedRef.current = true;

    closeSnackbar(snackbarId);
    enqueueSnackbar('XLSX data fetch finished!', {
      variant: 'success',
    });

    setSnackbarId(null);
    setFetchRequested(false);
  }, [
    data,
    isLoading,
    fetchRequested,
    snackbarId,
    enqueueSnackbar,
    setFetchRequested,
  ]);

  // ---- ONLY navigation-away case ----
  useEffect(() => {
    return () => {
      if (fetchRequested && snackbarId !== null && !completedRef.current) {
        closeSnackbar(snackbarId);
        enqueueSnackbar('XLSX data fetch failed by navigating away!', {
          variant: 'error',
        });
      }
    };
  }, [fetchRequested, snackbarId, enqueueSnackbar]);

  return { start };
};

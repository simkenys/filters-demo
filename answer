import { useEffect, useRef, useState } from 'react';
import { closeSnackbar, useSnackbar } from 'notistack';

const XLSX_MIME =
  'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';

export const useDownloadWithSnackbar = ({ data, isLoading }) => {
  const { enqueueSnackbar } = useSnackbar();

  const [snackbarId, setSnackbarId] = useState(null);
  const [requested, setRequested] = useState(false);

  // âœ… lifecycle truth source
  const completedRef = useRef(false);

  const startDownload = () => {
    if (requested) return;

    completedRef.current = false;

    const id = enqueueSnackbar(
      "XLSX data fetch started - please don't navigate away!",
      {
        variant: 'info',
        persist: true,
      }
    );

    setSnackbarId(id);
    setRequested(true);
  };

  // ---- Handle success / failure ----
  useEffect(() => {
    if (!requested || isLoading || !snackbarId) return;

    const record = data?.[0];
    if (!record?.blob) {
      enqueueSnackbar('No XLSX data received.', { variant: 'error' });
      closeSnackbar(snackbarId);
      setSnackbarId(null);
      setRequested(false);
      return;
    }

    // ----- Convert to Blob if needed -----
    const blob =
      record.blob instanceof Blob
        ? record.blob
        : typeof record.blob === 'string'
        ? (() => {
            const bytes = atob(record.blob);
            const arr = new Uint8Array(bytes.length);
            for (let i = 0; i < bytes.length; i++) {
              arr[i] = bytes.charCodeAt(i);
            }
            return new Blob([arr], { type: XLSX_MIME });
          })()
        : new Blob([record.blob], { type: XLSX_MIME });

    // ----- Download -----
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'extract.xlsx';
    document.body.appendChild(a);
    a.click();

    setTimeout(() => {
      URL.revokeObjectURL(url);
      a.remove();
    }, 0);

    // ----- Success -----
    completedRef.current = true;

    closeSnackbar(snackbarId);
    enqueueSnackbar('XLSX data fetch finished!', { variant: 'success' });

    setSnackbarId(null);
    setRequested(false);
  }, [requested, isLoading, snackbarId, data, enqueueSnackbar]);

  // ---- Cleanup: ONLY fire if navigated away mid-fetch ----
  useEffect(() => {
    return () => {
      if (requested && snackbarId && !completedRef.current) {
        closeSnackbar(snackbarId);
        enqueueSnackbar('XLSX data fetch failed by navigating away!', {
          variant: 'error',
        });
      }
    };
  }, [requested, snackbarId, enqueueSnackbar]);

  return {
    startDownload,
    isDownloading: requested,
  };
};



import React from 'react';
import { Card, CardActionArea, CardContent, Typography } from '@mui/material';
import useFetchBlobData from '../../dataHooks/useFetchBlobData';
import { useGlobalStore } from '../../contexts/useGlobalStore';
import useFetchUser from '../../dataHooks/useFetchUser';
import { useDownloadWithSnackbar } from './useDownloadWithSnackbar';

const CardDownload = () => {
  const { refogId } = useGlobalStore();
  const { user } = useFetchUser({ refogId });

  const fetch = useFetchBlobData(user?.currentUser ?? null);

  const { startDownload, isDownloading } = useDownloadWithSnackbar(fetch);

  return (
    <Card
      sx={{
        borderRadius: '12px',
        padding: 1.5,
        boxShadow: '0px 14px 40px rgba(34, 35, 58, 0.2)',
        cursor: 'pointer',
      }}
    >
      <CardActionArea
        sx={{ height: '300px' }}
        onClick={startDownload}
        disabled={isDownloading}
      >
        <CardContent>
          <Typography gutterBottom variant="h5">
            Download extract (.xlsx)
          </Typography>
          <Typography variant="body2" sx={{ color: 'text.secondary' }}>
            Click here to download an extract in .xlsx format which contains all
            data you are allowed to see.
          </Typography>
        </CardContent>
      </CardActionArea>
    </Card>
  );
};

export default CardDownload;

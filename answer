import { useEffect, useRef, useState } from 'react';
import { closeSnackbar, useSnackbar } from 'notistack';

const XLSX_MIME =
  'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';

export const useDownloadWithSnackbar = ({
  data,
  isLoading,
  fetchRequested,
  setFetchRequested,
}) => {
  const { enqueueSnackbar } = useSnackbar();
  const [snackbarId, setSnackbarId] = useState(null);

  // âœ… tracks whether download actually finished
  const completedRef = useRef(false);

  const start = () => {
    if (fetchRequested) return;

    completedRef.current = false;

    const id = enqueueSnackbar(
      "XLSX data fetch started - please don't navigate away!",
      {
        variant: 'info',
        persist: true,
      }
    );

    setSnackbarId(id);
    setFetchRequested(true); // ðŸ”‘ THIS triggers fetch
  };

  // ---- Handle success ----
  useEffect(() => {
    if (!fetchRequested || isLoading || !snackbarId) return;

    const record = data?.[0];
    if (!record?.blob) {
      enqueueSnackbar('No XLSX data received.', { variant: 'error' });
      closeSnackbar(snackbarId);
      setSnackbarId(null);
      setFetchRequested(false);
      return;
    }

    const blob =
      record.blob instanceof Blob
        ? record.blob
        : new Blob([record.blob], { type: XLSX_MIME });

    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'extract.xlsx';
    document.body.appendChild(a);
    a.click();

    setTimeout(() => {
      URL.revokeObjectURL(url);
      a.remove();
    }, 0);

    completedRef.current = true;

    closeSnackbar(snackbarId);
    enqueueSnackbar('XLSX data fetch finished!', { variant: 'success' });

    setSnackbarId(null);
    setFetchRequested(false);
  }, [data, isLoading, fetchRequested, snackbarId, enqueueSnackbar, setFetchRequested]);

  // ---- Cleanup: only if navigated away mid-fetch ----
  useEffect(() => {
    return () => {
      if (fetchRequested && snackbarId && !completedRef.current) {
        closeSnackbar(snackbarId);
        enqueueSnackbar('XLSX data fetch failed by navigating away!', {
          variant: 'error',
        });
      }
    };
  }, [fetchRequested, snackbarId, enqueueSnackbar]);

  return { start };
};


import React, { useState } from 'react';
import { Card, CardActionArea, CardContent, Typography } from '@mui/material';
import useFetchBlobData from '../../dataHooks/useFetchBlobData';
import { useGlobalStore } from '../../contexts/useGlobalStore';
import useFetchUser from '../../dataHooks/useFetchUser';
import { useDownloadWithSnackbar } from './useDownloadWithSnackbar';

const CardDownload = () => {
  const { refogId } = useGlobalStore();
  const { user } = useFetchUser({ refogId });

  const [fetchRequested, setFetchRequested] = useState(false);

  // âœ… fetch only after click
  const fetch = useFetchBlobData(
    fetchRequested ? user?.currentUser : null
  );

  const { start } = useDownloadWithSnackbar({
    data: fetch.data,
    isLoading: fetch.isLoading,
    fetchRequested,
    setFetchRequested,
  });

  return (
    <Card
      sx={{
        borderRadius: '12px',
        padding: 1.5,
        boxShadow: '0px 14px 40px rgba(34, 35, 58, 0.2)',
        cursor: 'pointer',
      }}
    >
      <CardActionArea sx={{ height: 300 }} onClick={start}>
        <CardContent>
          <Typography variant="h5">Download extract (.xlsx)</Typography>
          <Typography variant="body2" color="text.secondary">
            Click here to download an extract in .xlsx format.
          </Typography>
        </CardContent>
      </CardActionArea>
    </Card>
  );
};

export default CardDownload;
